@page
@model WarehouseClient.Pages.Receipts.CreateModel
@{
    ViewData["Title"] = "Создать поступление";
}

<h2 class="mb-3">@ViewData["Title"]</h2>

<div asp-validation-summary="All" class="text-danger"></div>

<form method="post">
    @Html.AntiForgeryToken()

    <div class="row g-3 mb-3">
        <div class="col-md-4">
            <label class="form-label">Номер</label>
            <input asp-for="Receipt.Number" class="form-control" />
        </div>
        <div class="col-md-4">
            <label class="form-label">Дата</label>
            <input asp-for="Receipt.Date" type="date" class="form-control" />
        </div>
        <div class="col-md-4 d-flex align-items-end justify-content-end">
            <button type="submit" class="btn btn-success">Сохранить</button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered align-middle">
            <thead class="table-secondary">
                <tr>
                    <th style="width:48px">
                        <button id="btnAddRow" type="button" class="btn btn-sm btn-success">+</button>
                    </th>
                    <th>Ресурс</th>
                    <th style="width:300px">Единица измерения</th>
                    <th style="width:200px">Количество</th>
                </tr>
            </thead>
            <tbody id="rows">
            </tbody>
        </table>
    </div>
</form>

<!-- Шаблон строки (клонируется JS). __index__ будет заменён на номер строки -->
<table class="d-none">
    <tbody>
        <tr id="row-template">
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-danger btn-remove">x</button>
            </td>
            <td>
                <input type="text" class="form-control" name="Lines[__index__].ResourceName" placeholder="Название ресурса" />
            </td>
            <td>
                <input type="text" class="form-control" name="Lines[__index__].UnitName" placeholder="Единица измерения" />
            </td>
            <td>
                <input type="number" class="form-control" name="Lines[__index__].Quantity" step="0.001" placeholder="Количество" />
            </td>
        </tr>
    </tbody>
</table>

@section Scripts {
    <script>
        (function () {
            const rows = document.getElementById('rows');
            const template = document.getElementById('row-template');

            function addRow() {
                const idx = rows.children.length;
                const clone = template.cloneNode(true);
                clone.id = '';
                clone.innerHTML = clone.innerHTML.replaceAll('__index__', idx);
                
                // Отладка: проверяем, что добавляется
                console.log('Adding row with index:', idx);
                console.log('Row HTML:', clone.innerHTML);
                
                rows.appendChild(clone);

                clone.querySelector('.btn-remove').addEventListener('click', function () {
                    clone.remove();
                    renumber();
                });
            }

            function renumber() {
                // пересчёт имён после удаления: Lines[0].*, Lines[1].*, ...
                [...rows.children].forEach((tr, i) => {
                    console.log('Renumbering row', i);
                    tr.querySelectorAll('select, input').forEach(el => {
                        const oldName = el.name;
                        el.name = el.name.replace(/Lines\[\d+\]/, `Lines[${i}]`);
                        console.log('Changed name from', oldName, 'to', el.name);
                    });
                });
            }

            document.getElementById('btnAddRow').addEventListener('click', addRow);
            
            // Добавляем одну строку по умолчанию при загрузке страницы
            console.log('Page loaded, adding default row');
            addRow();
        })();
    </script>
}